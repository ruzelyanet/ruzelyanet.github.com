import fs from 'fs';
import path from 'path';
import { sync as isDir } from 'is-directory';

const isPng = fp => !!/\.png$/i.test(fp);

const isSpriteDir = dir => fp => isDir(path.join(dir, fp));

const hasPngInSpriteDir = dir => fp => {
	const file = path.join(dir, fp);
	return !isDir(file) && isPng(file);
};

const hasIconsInSpriteDir = (dir, spritesPath) => fp => {
	const folder = path.join(dir, fp);

	if (!isDir(folder)) {
		return false;
	};

	const files = fs.readdirSync(folder);

	if (!files.length) {
		console.warn(`[sprites] Put icons to '${spritesPath}/${path.basename(folder)}' or delete this folder.`);
		return false;
	}

	return !!files.filter(hasPngInSpriteDir(folder)).length;
};

export default (cwd = process.cwd(), spritesPath = 'app/sprites') => {
	const dir = path.join(cwd, spritesPath);
	const hasSpritesDir = isDir(dir);

	if (!hasSpritesDir) {
		return false;
	}

	const spritesDirFiles = fs.readdirSync(dir);
	const hasIconsInSpritesDir = !!spritesDirFiles.filter(isPng).length;

	if (hasIconsInSpritesDir) {
		console.warn(`[sprites] Move icons from '${spritesPath}' to '${spritesPath}/<name>' or delete them.`)
		return false;
	}

	const hasIconsInSpriteDirs = !!spritesDirFiles.filter(hasIconsInSpriteDir(dir, spritesPath)).length;

	if (!hasIconsInSpriteDirs) {
		return false;
	}

	return true;
};
